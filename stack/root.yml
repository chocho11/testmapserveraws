AWSTemplateFormatVersion: "2010-09-09"
Description: "Root stack for MapServer infrastructure"
Parameters:
  TemplateBucket:
    Type: String
    Description: "Nom du bucket S3 contenant les templates CloudFormation"

    # ---------------------------
        # déploiement à partir du cloudshell de aws

        # curl -L \
        #   https://raw.githubusercontent.com/chocho11/testmapserveraws/refs/heads/main/stack/root.yml \
        #   -o root.yml

        # aws cloudformation deploy \
        #  --stack-name mapserver-root \
        #  --template-file root.yml \
        #  --parameter-overrides TemplateBucket=mon-bucket-mapserver \
        #  --capabilities CAPABILITY_NAMED_IAM
    # --------------------------
    
Resources:

  VPCStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TemplateURL: !Sub "https://${TemplateBucket}.s3.amazonaws.com/vpc.yml"

  SGStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TemplateURL: !Sub "https://${TemplateBucket}.s3.amazonaws.com/sg.yml"
    DependsOn: VPCStack

  EFSStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TemplateURL: !Sub "https://${TemplateBucket}.s3.amazonaws.com/efs.yml"
    DependsOn: SGStack
  
  ASGStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TemplateURL: !Sub "https://${TemplateBucket}.s3.amazonaws.com/lb-asg-tg.yml"
    DependsOn:
      - SGStack
      - EFSStack