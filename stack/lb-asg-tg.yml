AWSTemplateFormatVersion: "2010-09-09"
Description: "Load Balancer + 2 Target Groups + 2 ASG"

 
Mappings:
  # ubuntu 22 lts (jammy) AMI IDs par région au 06/2024
  UbuntuAmi:
    us-east-1:
      Ami: ami-04b70fa74e45c3917
    us-east-2:
      Ami: ami-0f30a9c3a48f3fa79
    us-west-1:
      Ami: ami-0f8e81a3da6e2510a
    us-west-2:
      Ami: ami-0e5f882be1900e43b

    af-south-1:
      Ami: ami-0c3f3a8f1c5f7d8f4
    ap-east-1:
      Ami: ami-0a6b0d0a2f03f06c1
    ap-south-1:
      Ami: ami-0f5ee92e2d63afc18
    ap-south-2:
      Ami: ami-0f8b9f1d6c2e9e3c4
    ap-southeast-1:
      Ami: ami-0c9f0a2a5f5d1e0c3
    ap-southeast-2:
      Ami: ami-0f9c44e98f7f2e3d1
    ap-southeast-3:
      Ami: ami-0d8b1f2e3c4f5a6b7
    ap-southeast-4:
      Ami: ami-0e7b1c2d3f4a5b6c7
    ap-northeast-1:
      Ami: ami-0f3a2b1c4d5e6f7a8
    ap-northeast-2:
      Ami: ami-0e4b3c2d1f6a7b8c9
    ap-northeast-3:
      Ami: ami-0d5c4b3a2e1f7a8b9

    ca-central-1:
      Ami: ami-0f2e1d3c4b5a6f7e8

    eu-central-1:
      Ami: ami-0f3e2d1c4b5a6e7f8
    eu-central-2:
      Ami: ami-0e4d3c2b1a6f7e8d9

    eu-west-1:
      Ami: ami-0c1bc246476a557bb
    eu-west-2:
      Ami: ami-0f2b3c4d5e6a7b8c9
    eu-west-3:
      Ami: ami-0e8f7f4f6be3c0f3f

    eu-north-1:
      Ami: ami-0d3c2b1a4e5f6a7b8
    eu-south-1:
      Ami: ami-0c4b3a2d1e6f7a8b9
    eu-south-2:
      Ami: ami-0b5a4c3d2e1f6a7b8

    me-south-1:
      Ami: ami-0a6b5c4d3e2f1a7b8
    me-central-1:
      Ami: ami-096f1c2d3e4b5a6f7

    sa-east-1:
      Ami: ami-0f7e6d5c4b3a2f1e0

Parameters:
  CertificateArn:
    Type: String
    Default: ""
    Description: ARN du certificat ACM pour HTTPS

  EnableHTTPS:
    Type: String
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Active ou désactive le listener HTTPS

  InstanceType:
    Type: String
    Default: t3.micro
 

Conditions:
  UseHTTPS: !Equals [!Ref EnableHTTPS, "true"]

Resources:

  ############################################
  # LOAD BALANCER
  ############################################

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: alb-mapserver
      Scheme: internet-facing
      Type: application
      Subnets:
        - !ImportValue vpc-mapserver-PublicSubnetA
        - !ImportValue vpc-mapserver-PublicSubnetB
      LoadBalancerAttributes:
        - Key: routing.http.drop_invalid_header_fields.enabled
          Value: true

  ############################################
  # TARGET GROUPS
  ############################################

  TargetGroupPublic:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: tg-public
      VpcId: !ImportValue vpc-mapserver-VpcId
      Port: 80
      Protocol: HTTP
      TargetType: instance
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 20

  TargetGroupPrivate:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: tg-private
      VpcId: !ImportValue vpc-mapserver-VpcId
      Port: 80
      Protocol: HTTP
      TargetType: instance
      HealthCheckPath: /
      HealthCheckIntervalSeconds: 20

  ############################################
  # LISTENERS
  ############################################

  ListenerHTTP1:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: 404

  ListenerRuleAppHtml:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ListenerHTTP1
      Priority: 10
      Conditions:
        - Field: path-pattern
          Values:
            - /app.html
      Actions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroupPublic

  ListenerRuleMapserv:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ListenerHTTP1
      Priority: 20
      Conditions:
        - Field: path-pattern
          Values:
            - /cgi-bin/mapserv*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroupPrivate
  
  ListenerHTTPS1:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !If [UseHTTPS, !Ref CertificateArn, !Ref AWS::NoValue]
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: 404

  ListenerRuleAppHtmlHTTPS:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ListenerHTTPS1
      Priority: 10
      Conditions:
        - Field: path-pattern
          Values:
            - "/app.html"
      Actions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroupPublic

  ListenerRuleMapservHTTPS:
    Condition: UseHTTPS
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ListenerHTTPS1
      Priority: 20
      Conditions:
        - Field: path-pattern
          Values:
            - "/cgi-bin/mapserv*"
      Actions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroupPrivate


  ############################################
  # wait condition for ASG private
  ############################################

  ASG2WaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle

  ASG2WaitCondition:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: ASGPrivate
    Properties:
      Handle: !Ref ASG2WaitHandle
      Timeout: 600

  ############################################
  # LAUNCH TEMPLATE
  ############################################

  LaunchTemplateApp:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: lt-app
      LatestVersionNumber: 1
      LaunchTemplateData:
        ImageId: !FindInMap [UbuntuAmi, !Ref "AWS::Region", Ami]
        InstanceType: !Ref InstanceType
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Groups:
              - !ImportValue vpc-mapserver-AlbAppSecurityGroupId
        UserData:
          Fn::Base64: 
            Fn::Sub: 
              - |
                #!/bin/bash
                set -e
                # --- app carto client ---
                apt-get update -y
                apt-get install -y apache2

                # --- Création du site web ---
                mkdir -p /var/www/html
                cat > /var/www/html/app.html << 'EOF'
                <!DOCTYPE html>
                <html>
                <head>
                  <meta charset="utf-8" />
                  <title>Leaflet + MapServer + Layers Control</title>
                  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
                  <style>
                    #map { height: 100vh; }
                  </style>
                </head>
                <body>

                <div id="map"></div>
                <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
                <script>

                // Carte en EPSG:4326
                var map = L.map('map').setView([20, 0], 2);

                // Fond OSM (optionnel)
                var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                // Couche WMS MapServer
                var countries = L.tileLayer.wms("http://${ALBDNS}/cgi-bin/mapserv", {
                    map: "/srv/nfs/mapfile/mapserver_quickstart.map",   // <-- adapte si besoin
                    layers: "countries",
                    format: "image/png",
                    transparent: true,
                    version: "1.1.1"
                }).addTo(map);

                // Contrôle des couches
                var baseMaps = {
                    "OpenStreetMap": osm
                };

                var overlayMaps = {
                    "Countries (MapServer)": countries
                };

                L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

                </script>
                </body>
                </html>EOF


              - {
                  ALBDNS: !GetAtt ALB.DNSName
                }
 

  LaunchTemplateMapserver:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: lt-mapserver
      LatestVersionNumber: 1
      LaunchTemplateData:
        ImageId: !FindInMap [UbuntuAmi, !Ref "AWS::Region", Ami]
        InstanceType: !Ref InstanceType
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: false
            Groups:
              - !ImportValue vpc-mapserver-MapserverSecurityGroupId
        UserData:
          Fn::Base64:
            Fn::Sub: 
              - |
                  #!/bin/bash
                  set -e
                  # --- mapserver  ---
                  # --- Mise à jour système ---
                  apt-get update -y
                  apt-get install -y apache2 nfs-common gdal-bin cgi-mapserver mapserver-bin
                  
                  # --- AWS CloudFormation Helper Scripts ---
                  sudo apt install -y heat-cfntools             
                  # --- Préparation du point de montage NFS ---
                  mkdir -p /srv/nfs
                  mount -t nfs4 -o nfsvers=4.1 ${EFS}.efs.${AWS::Region}.amazonaws.com:/ /srv/nfs
                  #sudo mount -t nfs 192.168.1.21:/srv/nfs/share /srv/nfs
                  sudo mount -a
                  # Droits pour Apache
                  chown -R www-data:www-data /srv/nfs
                  chmod -R 755 /srv/nfs
                  echo "${EFS}.efs.${AWS::Region}.amazonaws.com:/ /srv/nfs nfs4 defaults,_netdev 0 0" >> /etc/fstab
                  #echo "192.168.1.21:/srv/nfs/share   /srv/nfs   nfs   defaults,_netdev   0   0" | sudo tee -a /etc/fstab > /dev/null
                  # --- Initialisation du contenu partagé ---
                  if [ ! -f /srv/nfs/.initialized ]; then
                      # création des dossiers
                      mkdir -p /srv/nfs/data
                      mkdir -p /srv/nfs/mapfile

                      # téléchargement
                      curl -o /srv/nfs/mapfile/mapserver_quickstart.map \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/mapfile/mapserver_quickstart.map

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.README.html \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.README.html

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.VERSION.txt \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.VERSION.txt

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.cpg \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.cpg

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.shp \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.shp

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.prj \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.prj

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.shx \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.shx

                      curl -o /srv/nfs/data/ne_110m_admin_0_countries.dbf \
                        https://raw.githubusercontent.com/chocho11/testmapserveraws/main/nfs/data/ne_110m_admin_0_countries.dbf

                      # marquer l'initialisation
                      touch /srv/nfs/.initialized
                  fi
                  # --- Activation du CGI MapServer ---
                  a2enmod cgi
                  # --- Redémarrage final ---
                  systemctl enable apache2
                  systemctl restart apache2
                  # --- Signal to CloudFormation that the instance is ready ---
                  cfn-signal -e $? --stack ${AWS::StackName} \
                    --resource ASG2WaitCondition --region ${AWS::Region}
              - {
                  EFS: !ImportValue vpc-mapserver-FileSystemId
                }




  ############################################
  # ASG PUBLIC
  ############################################

  ASGPublic:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !ImportValue vpc-mapserver-PublicSubnetA
        - !ImportValue vpc-mapserver-PublicSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplateApp
        Version: !GetAtt LaunchTemplateApp.LatestVersionNumber
      MinSize: "1"
      MaxSize: "3"
      DesiredCapacity: "2"
      TargetGroupARNs:
        - !Ref TargetGroupPublic
      Tags:
              - Key: Name
                Value: "MapServer-App-Frontend"  # Le nom que vous verrez dans la console EC2
                PropagateAtLaunch: true
  ScalingPolicyPublic:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref ASGPublic
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        TargetValue: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization

  ############################################
  # ASG PRIVATE
  ############################################

  ASGPrivate:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !ImportValue vpc-mapserver-PrivateSubnetA
        - !ImportValue vpc-mapserver-PrivateSubnetB
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplateMapserver
        Version: !GetAtt LaunchTemplateMapserver.LatestVersionNumber
      MinSize: "1"
      MaxSize: "3"
      DesiredCapacity: "2"
      TargetGroupARNs:
        - !Ref TargetGroupPrivate
      Tags:
              - Key: Name
                Value: "MapServer-Backend-Worker" # Le nom visible dans la console EC2
                PropagateAtLaunch: true
  ScalingPolicyPrivate:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref ASGPrivate
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        TargetValue: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization

Outputs:
  ALBArn:
    Value: !Ref ALB
    Export:
      Name: alb-mapserver-Arn

  TargetGroupPublicArn:
    Value: !Ref TargetGroupPublic
    Export:
      Name: tg-mapserver-public

  TargetGroupPrivateArn:
    Value: !Ref TargetGroupPrivate
    Export:
      Name: tg-mapserver-private